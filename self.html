<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<script></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/css/bootstrap.css">
	<style>
		body {
			padding: 60px 40px;
		}
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.js"></script>
	<script src="./self.implement.js"></script>
</head>

<body>

	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container-fluid">
				<a class="brand" href="#">please forget my dirty way to use jquery</a>
			</div>
		</div>
	</div>
	<div class="container-fluid">

		<div class="row-fluid">
			<div class="span3">
				<div class="well sidebar-nav">
					<ul class="nav nav-list j-menus">
						<li class='home'>
							<a href="#!/">home</a>
						</li>
						<li class='user'>
							<a href="#!/user">user</a>
						</li>
					</ul>
				</div>
			</div>
			<div class="span9">
				<div class="row j-app"></div>
			</div>
		</div>
	</div>


	<script class="nav" id="user-tpl" type='text/template'>
<div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <ul class="nav j-menu">
        <li class='user-list'><a href="#!/user">list</a></li>
        <li class="user-detail"><a href="javascript:;">detail</a></li>
        <li class="user-config"><a href="#!/user/config">config</a></li>
      </ul>
    </div>
  </div>
</div>
</div>
<div class="row-fluid j-user"></div>
</script>



	<script type="text/javascript">


		function activeOne(className) {
			var $menu = $(".j-menu");
			$menu.find('li').removeClass("active");
			$menu.find(className).addClass("active");
		}
		var routes = [
			{
				path: "/",
				enter: function (route, next) {
					$(".j-menus .home").addClass("active");
					$(".j-app").html("<h2>HOME<h2>");
				},
				leave: function (route, next) {
					$(".j-menus .home").removeClass("active");
					// return false can prevent leave! util you invoke `next` manually
					setTimeout(function () {
						next();
					}, 1000);
					return false;
				}
			},
			{
				path: "/user",
				enter: function (route, next) {
					$(".j-app")[0].innerHTML = $("#user-tpl").html();
					$(".j-menus .user").addClass("active");
					// in real enviroment, you need a template engine to complete the work.
					activeOne(".user-list");
					var list = "<ul>";
					for (var i = 0; i < 4; i++) {
						list += "<li><a href='#!/user/" + i + "'>user " + i + "</a></li>"
					}
					list += "</ul>"
					$(".j-user").html(list);
				},
				leave: function (route, next) {
					$(".j-menus .user").removeClass("active");
				}
			},
			{
				path: "/user/list",
				parent: "/user",
				enter: function (route, next) {


				}
			},
			{
				path: "/user/:id",
				enter: function (route, next) {
					activeOne(".user-detail");
					// update or enter, we need update the user infomation
					$(".j-user").html("<h4><a href='#!/user'><< return list</a></h4>User " + route.params.id + "'s detail");
				}
			},
			{
				path: "/user/config",
				enter: function (route, next) {
					activeOne(".user-config");
					$(".j-user").html("<p class='well'>user config page. <p><b>when you leave this page, you should confirm</b>");
				},
				leave: function (route, go) {
					// 
					if (confirm('确定离开?')) {
						console.log('you can leave now.')
						go(route);
					}
					// remember to return false, if you don't want to leave without confirm.
					return false;
				}
			}
		];
		routes.forEach(function (route) {
			lxr.on(route);
		});
		lxr.start();
		// var stateman = new StateMan();

		// stateman
		// 	.state(states)
		// 	.state("user.config", function () {
		// 		activeOne(".user-config");
		// 		$(".j-user").html("<p class='well'>user config page<p>");
		// 	})
		// 	.on("notfound", function (path) {
		// 		stateman.go("home", { replace: true });
		// 	})
		// 	.on("end", function () {

		// 	})
		// 	.start({ html5: true, "root": "/layout.html" })


		var a = {
			before: function (route, next) {
				console.log('a before!')
				setTimeout(function () {
					next(route)
				}, 1000);
				return false;
			},
			enter: function (route) {
				console.log('a entered!')
			}
		};
		var b = {
			parent: a,
			before: function (route, next) {
				console.log('b before!')
				setTimeout(function () {
					next(route)
				}, 1000);
				return false;
			},
			enter: function (route) {
				console.log('b entered!')
			}
		};
		var c = {
			parent: b,
			before: function (route, next) {
				console.log('c before!')
				setTimeout(function () {
					next(route)
				}, 1000);
				return false;
			},
			enter: function (route) {
				console.log(' c entered!', route);
			}
		};
		var fnChain = function (route) {
			a.before(route, function (route) {
				a.enter(route);
				b.before(route, function (route) {
					b.enter(route);
					c.before(route, function (route) {
						c.enter(route);
					})
				})
			})
		};
		var getChain = function (rou) {
			var routeArray = [rou];
			var par = rou;
			while (par = par.parent) {
				routeArray.push(par);

			}
			console.log(routeArray);
			// return function (routeArray) {
			// reduceRight 的执行结果, 必须返回一个以 route 为参数的函数
			return routeArray.reduceRight(function (first, second) {
				var execute = function (route) {
					if (second.before) {
						second.before(route, function (route) {
							second.enter(route);
						})
					} else {
						second.enter(route);
					}
				};
				console.log(first, second);
				return function (route) {
					var par = second.parent;
					if (par.before) {
						par.before(route, function (route) {
							par.enter(route);
							execute(route);
						})
						// par.enter(route);
					} else if (par.enter) {
						par.enter(route);
					}
				}

			});
			// }
		};
		// getChain(c);
		// fnChain({ path: '/a/b/c' });
		var autoChain = getChain(c);
		autoChain({ path: '/haha/a/b/c' })
	</script>
</body>

</html>